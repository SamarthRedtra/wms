var ke=Object.defineProperty;var K=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var X=(p,r,n)=>r in p?ke(p,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):p[r]=n,Y=(p,r)=>{for(var n in r||(r={}))xe.call(r,n)&&X(p,n,r[n]);if(K)for(var n of K(r))Se.call(r,n)&&X(p,n,r[n]);return p};var f=(p,r,n)=>new Promise((q,y)=>{var I=c=>{try{E(n.next(c))}catch(A){y(A)}},m=c=>{try{E(n.throw(c))}catch(A){y(A)}},E=c=>c.done?q(c.value):Promise.resolve(c.value).then(I,m);E((n=n.apply(p,r)).next())});import{u as Ce,a as s,a9 as Z,w as ee,c as te,ac as Re,b as Ne,x as ae,l as qe,n as k,f as l,v as o,a3 as N,ad as oe,j as d,E as Q,I as w,F as $,k as S,q as C,a6 as Ie,a4 as z,t as Ee,$ as se,H as Ae}from"./frappe-ui-cec019df.js";import De from"./BaseLayout-ecda517c.js";import{Q as B}from"./quagga.min-73bcc46f.js";import{a as R}from"./axios-fc3df026.js";import{u as Le}from"./index-95e515d9.js";import"./index-0e5fa8f2.js";import"./notifications-0a235be6.js";const Oe={class:"flex flex-col items-center"},Qe=o("p",null,"Purpose",-1),$e=o("option",{value:""},null,-1),Be=o("option",{value:"Opening Stock"},"Opening Stock",-1),Ue=o("option",{value:"Stock Reconciliation"},"Stock Reconciliation",-1),je=[$e,Be,Ue],Pe=o("p",null,"Company",-1),Me=["value"],Ve={id:"addSummary",class:"text-base leading-6 rounded py-6 px-4 border-none",style:{width:"90%"}},ze=o("p",null,"Stock Entries",-1),Te={class:"flex flex-col gap-5 my-4",style:{width:"90%"}},Fe={class:"flex flex-col bg-white rounded"},Je=["onClick"],We={class:"flex flex-row items-center gap-3 grow"},He={class:"text-xs font-normal text-gray-800 leading-6"},Ge={id:"circleii"},Ke={id:"reader"},Xe={key:0,class:"add-form"},Ye=o("br",null,null,-1),Ze=o("label",{for:"itemName"},"Item",-1),et={class:"barcode-input"},tt={id:"searchName"},at=["value"],ot=o("br",null,null,-1),st=o("label",{for:"itemName"},"Warehouse",-1),nt={class:"barcode-input"},rt={id:"searchWarehouse"},lt=["value"],ct=o("br",null,null,-1),it=o("label",{for:"itemName"},"Quantity",-1),ut=o("br",null,null,-1),dt=o("br",null,null,-1),mt=o("div",{id:"barcodeScanner"},null,-1),vt=[mt],pt={class:"flex flex-col gap-5 my-4 w-full"},ht={class:"flex flex-col bg-white rounded"},_t={class:"flex flex-row items-center gap-3 grow"},ft={class:"text-sm font-normal text-gray-800 leading-6"},yt={id:"circleii"},It={__name:"NewStockCount",setup(p){const{cookies:r}=Le(),n=Ce(),q=s("");q.value=n.query.linkName,s(!1);const y=s(!1);s("");const I=s(!1),m=s({}),E=t=>{m.value=Y({},t),h.value=t.itemCode,g.value=t.warehouse,v.value=t.quantity,y.value=!0},c=()=>f(this,null,function*(){y.value=!1,O.value=!1}),A=()=>f(this,null,function*(){y.value=!1,I.value=!0;try{yield ne(),re()}catch(t){console.error("Error loading Quagga:",t)}}),ne=()=>new Promise((t,a)=>{const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js",e.onload=t,e.onerror=a,document.head.appendChild(e)}),re=()=>{B.init({inputStream:{name:"Live",type:"LiveStream",target:document.querySelector("#barcodeScanner")},decoder:{readers:["ean_reader"]}},function(t){if(t){console.error(t);return}B.start()})},le=()=>{I.value=!1,B&&B.stop&&B.stop()},T=()=>{y.value=!y.value,O.value=!1},ce=()=>{window.location.href="/StockCount"};Z({doctype:"Purchase Order",fields:["*"],auto:!0});const ie=Z({doctype:"Warehouse",fields:["*"],auto:!0}),F=s([]);ee(()=>ie.data,t=>{if(t&&Array.isArray(t)){const a=t.filter(e=>e.is_group===0);F.value=a.map(e=>e.name)}});const h=s(""),g=s(""),v=s(0),ue=s(""),de=s(""),me=s([]),ve=s([]);s({});const P=s([]);(()=>f(this,null,function*(){try{const t=yield R.get("/api/method/wms.api.my_api.get_all_items");P.value=t.data.message,console.log("itemList data",P.value)}catch(t){console.error("Error fetching warehouse:",t)}}))();const M=s([]);(()=>f(this,null,function*(){try{const t=yield R.get("/api/method/wms.api.my_api.get_all_company");M.value=t.data.message,console.log("companyList data",M.value)}catch(t){console.error("Error fetching warehouse:",t)}}))(),ee(ue,t=>f(this,null,function*(){t&&(yield fetchItemData(t))}));const b=s([]),J=()=>{const t=h.value,a=g.value,e=Number(v.value),u=b.value.find(x=>x.itemCode===t&&x.warehouse===a);u?u.quantity+=e:b.value.push({itemCode:t,warehouse:a,quantity:e}),V()},W=()=>h.value.trim()!==""&&g.value.trim()!==""&&v.value!==null&&!isNaN(v.value)&&v.value>0,pe=()=>{if(W()){if(m.value.itemCode){const t=b.value.find(a=>a.itemCode===m.value.itemCode&&a.warehouse===m.value.warehouse);t&&(t.quantity=v.value,t.warehouse=g.value,t.itemCode=h.value)}else J();V(),m.value={}}},he=()=>{if(W()){if(m.value.itemCode){const t=b.value.find(a=>a.itemCode===m.value.itemCode&&a.warehouse===m.value.warehouse);t&&(t.quantity=v.value,t.warehouse=g.value,t.itemCode=h.value)}else J();V(),T(),m.value={}}},V=()=>{h.value="",v.value="",g.value="",de.value=""},_e=s([]);_e.value=ve.value,s("");let i=s("New");const D=s(""),L=s(""),O=s(!1),U=s(""),fe=()=>{O.value=!0;const t=new Html5Qrcode("reader");t.start({facingMode:"environment"},a=>{console.log("QR code scanned:",a),alert("QR code scanned: "+a),G(U.value),H(t)},a=>{U.value=a,alert(" QR code: "+U.value),G(U.value),H(t)})},H=t=>{O.value=!1,t.stop()},j=s(""),G=t=>f(this,null,function*(){try{const a=yield fetch(`/api/method/wms.api.my_api.item_match_with_qr?barcode=${t}`);if(!a.ok)throw new Error("Network response was not ok");const e=yield a.json();return j.value=e.message.parent,console.log("dat returned :",e.message.parent),e}catch(a){return console.error("Error fetching item details:",a),null}}),ye=te(()=>{const t=new Set;return me.value.filter(a=>{const e=t.has(a.name);return t.add(a.name),!e})});te(()=>ye.value.some(t=>t.name===j.value)),Re(()=>{j.value&&(h.value=j.value)}),console.log("linkName",q);const _=s([]),ge=()=>f(this,null,function*(){try{const t=yield R.get("/api/method/wms.api.my_api.get_stock_by_name",{params:{name:q.value}});if(_.value=t.data.message,console.log("apiData",_.value),t.data&&t.data.message&&(L.value=_.value.purpose||"",D.value=_.value.company||"",_.value.items&&_.value.items.length>0)){const a=_.value.items[0];h.value=a.item_code||"",g.value=a.warehouse||"",v.value=a.qty||""}_.value?(i.value=_.value.name,_.value.items.forEach(a=>{b.value.push({itemCode:a.item_code,warehouse:a.warehouse,quantity:a.qty})})):console.error("Invalid response data:",t.data)}catch(t){console.log("Error while fetching data",t.response)}});Ne(()=>{n.query.linkName&&ge()});const we=()=>f(this,null,function*(){const t=r.get("sid"),a={company:D.value,purpose:L.value,items:b.value.map(e=>({item_code:e.itemCode,warehouse:e.warehouse,qty:e.quantity})),docstatus:0};try{if(i.value&&i.value!=="New"){const e=yield R.put(`/api/resource/Stock Reconciliation/${i.value}`,a,{headers:{Authorization:`Bearer ${t}`}});console.log("Updated Stock Reconciliation",e.data),alert("Updated Stock Reconciliation: "+e.data.data.name)}else{const e=yield R.post("/api/resource/Stock Reconciliation",a,{headers:{Authorization:`Bearer ${t}`}});console.log("Created Stock Reconciliation",e.data),i.value=e.data.data.name,alert("Created Stock Reconciliation: "+i.value)}}catch(e){console.error("Error in Stock Reconciliation process:",e);try{const u=JSON.parse(e.response.data._server_messages),x=JSON.parse(u[0]);alert(x.message)}catch(u){console.error("Error parsing server message:",u),alert("An unexpected error occurred.")}}}),be=()=>f(this,null,function*(){const t=r.get("sid"),a={company:D.value,purpose:L.value,items:b.value.map(e=>({item_code:e.itemCode,warehouse:e.warehouse,qty:e.quantity})),docstatus:1};try{if(i.value&&i.value!=="New"){const e=yield R.put(`/api/resource/Stock Reconciliation/${i.value}`,a,{headers:{Authorization:`Bearer ${t}`}});console.log("Updated Stock Reconciliation",e.data),alert("Updated Stock Reconciliation: "+e.data.data.name)}else{const e=yield R.post("/api/resource/Stock Reconciliation",a,{headers:{Authorization:`Bearer ${t}`}});console.log("Created Stock Reconciliation",e.data),i.value=e.data.data.name,alert("Created Stock Reconciliation: "+i.value)}}catch(e){console.error("Error in Stock Reconciliation process:",e);try{const u=JSON.parse(e.response.data._server_messages),x=JSON.parse(u[0]);alert(x.message)}catch(u){console.error("Error parsing server message:",u),alert("An unexpected error occurred.")}}});return(t,a)=>(l(),ae(De,{pageTitle:k(i),home:"edit",onCartIconClick:ce,class:"text-xs"},{body:qe(()=>[o("div",Oe,[o("div",{onClick:c,id:"containerIII",class:"flex justify-around text-base leading-6 rounded w-full py-1 px-4 border-none mt-5"},[Qe,N(o("select",{"onUpdate:modelValue":a[0]||(a[0]=e=>L.value=e)},je,512),[[oe,L.value]])]),o("div",{onClick:c,id:"containerII",class:"flex justify-around text-base leading-6 rounded w-full py-1 px-4 border-none"},[Pe,N(o("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>D.value=e)},[(l(!0),d($,null,Q(M.value,e=>(l(),d("option",{key:e.name,value:e.name},w(e.name),9,Me))),128))],512),[[oe,D.value]])]),o("div",Ve,[ze,S(k(C),{name:"plus",class:"h-6 w-6 text-black-500 cursor-pointer",onClick:T})]),o("div",Te,[o("div",Fe,[(l(!0),d($,null,Q(b.value,(e,u)=>(l(),d("div",{id:"basedOnActiveTabs",class:"flex flex-row flex-start p-4 items-center justify-between border-b cursor-pointer",key:u,onClick:x=>E(e)},[o("div",We,[S(k(C),{name:"edit",class:"h-5 w-5 text-gray-500"}),o("div",He,[o("p",null,w(e.itemCode)+" | "+w(e.warehouse),1)]),o("div",Ge,w(e.quantity),1)]),S(k(C),{name:"chevron-right",class:"h-5 w-5 text-gray-500"})],8,Je))),128))])]),N(o("div",Ke,null,512),[[Ie,O.value]]),y.value?(l(),d("div",Xe,[o("div",{onClick:c,id:"space"},[o("div",{onClick:c,id:"scrollerLine"})]),Ye,Ze,o("div",et,[N(o("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>h.value=e),placeholder:"Search item name here",list:"searchName",id:"nameField"},null,512),[[z,h.value]]),o("datalist",tt,[(l(!0),d($,null,Q(P.value,e=>(l(),d("option",{key:e.name,value:e.name},w(e.name),9,at))),128))]),Ee(),o("span",{class:"barcode-scanner",id:"QRcodescanner",onClick:fe},[S(k(C),{name:"maximize",class:"h-6 w-6 text-black-500"})])]),ot,st,o("div",nt,[N(o("input",{placeholder:"Search item by warehouse",list:"searchWarehouse",id:"wareHouseName","onUpdate:modelValue":a[3]||(a[3]=e=>g.value=e)},null,512),[[z,g.value]]),o("datalist",rt,[(l(!0),d($,null,Q(F.value,e=>(l(),d("option",{key:e,value:e},w(e),9,lt))),128))]),o("span",{class:"barcode-scanner",onClick:A},[S(k(C),{name:"maximize",class:"h-6 w-6 text-black-500"})])]),ct,it,N(o("input",{"onUpdate:modelValue":a[4]||(a[4]=e=>v.value=e),type:"number",id:"quantity",placeholder:"change quantity"},null,512),[[z,v.value]]),ut,o("button",{id:"addNew",onClick:pe},"Submit and Add New"),dt,o("button",{id:"sub",onClick:he},"Submit ")])):se("",!0),I.value?(l(),d("div",{key:1,class:"barcode-scanner-container",onClick:le},vt)):se("",!0),o("div",pt,[o("div",ht,[(l(!0),d($,null,Q(t.submittedData,e=>(l(),d("div",{class:"flex flex-row flex-start p-4 items-center justify-between border-b",key:e.title},[o("div",_t,[(l(),ae(Ae(e.icon),{class:"h-5 w-5 text-gray-500"})),S(k(C),{name:"shopping-cart",class:"h-5 w-5 text-gray-500"}),o("div",ft,[o("p",null,w(e.itemCode)+"| "+w(e.warehouse),1)]),o("div",yt,w(e.quantity),1)]),S(k(C),{name:"chevron-right",class:"h-5 w-5 text-gray-500"})]))),128))])]),o("div",{id:"btnDiv",class:"w-full flex justify-around sm:w-96 py-2 standalone:pb-safe-bottom"},[o("button",{id:"submitPurchaseReceipt",onClick:be},"Submit"),o("button",{id:"savePurchaseReceipt",onClick:we},"Save")])])]),_:1},8,["pageTitle"]))}};export{It as default};
